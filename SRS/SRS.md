## 3. 系统功能

### 3.1 血糖监测与记录

#### 3.1.1 描述

优先级：中

每隔15分钟记录一次血糖，生成当日血糖走势图，并据此给出健康贴士。走势图中有高血糖与低血糖的阈值，可以起到预警的作用。还可以查看历史日、周、月的血糖图或者表格。

####                 ![img](../assets/clip_image002.png)    

####   3.1.2 动机/反应顺序

##### 3.1.2.1. 用户启动血糖监测:

用户佩戴血糖仪并启动血糖监测。

系统每15分钟记录一次数据。

##### 3.1.2.2实时血糖检查:

用户请求实时血糖信息。

系统响应并显示当前血糖水平。

##### 3.1.2.3查看历史数据 - 每日记录:

用户想要查看每日血糖记录。

系统呈现一个用于选择日期的日历。

##### 3.1.2.4选择历史日期 - 在15天内:

用户选择在过去15天内的日期。

系统提供图形（图像模式）或表格（文字模式）表示的选项。

##### 3.1.2.5图形表示 - 图像模式:

用户选择图像模式以图形表示。

系统显示所选日期的趋势图和血糖摘要。

用户可以点击数据点以获取详细信息。

##### 3.1.2.6文本表示 - 文字模式:

用户选择文字模式以表格表示。

系统显示包含时间点和相应血糖值的表格。

##### 3.1.2.7选择历史日期 - 超过15天:

用户尝试选择超过15天的日期。

系统拒绝访问并提供适当的错误消息。

##### 3.1.2.8查看多日记录 - 周和月记录:

用户想要查看多日血糖记录。

系统呈现周和月视图的选项。

##### 3.1.2.9周视图:

用户选择周视图。

系统显示一个用于选择周的日历。

用户选择开始的日期后，系统显示该周的趋势图。

##### 3.1.2.10月视图:

用户选择月视图。

系统显示一个包含12个月的日历。

用户选择一个特定月份后，系统显示该月的趋势图。

#### 3.1.3  功能需求

1. 系统在监测期间必须每15分钟记录一次血糖数据。

1. 用户应能够启动和终止血糖监测。
2. 实时血糖数据必须能够在用户请求时访问。
3. 系统应提供用户友好的日历界面，用于选择历史日期。
4. 图形表示（图像模式）必须包括趋势图和每日摘要。
5. 文本表示（文字模式）必须包括包含时间点和血糖值的表格。
6. 超过15天的历史数据访问必须受到限制，并提供适当的错误消息。
7. 周和月视图应根据用户选择的时间范围显示趋势图。

##### 异常：

1. 系统不能成功获取血糖：记录为缺失/暂时与上一次记录相同/等待下一次血糖出现后进行拟合并提示用户。（TBD）
2. 用户选择日期错误(当前日期之后或者日期过早)：提示用户选择日期错误，如果是日期过早，那么就会显示最早的一次或一组记录；如果是当前日期之后，那么就显示今天对应的日/周/月记录。
3. 选择无数据日期：当日用户并未检测血糖，提示用户无数据。
4. 用户突然中断血糖监测：系统记录中断事件并显示在图标上。
5. 血糖仪故障：系统提示用户血糖仪故障，并让用户尝试重新连接。

### 3.2 运动方案生成

#### 3.2.1 描述

优先级：高

根据用户的健康档案生成运动方案，提醒用户去执行。

####                 ![img](..\assets\clip_image004.png)    

####   3.2.2 动机/反应顺序

##### 3.2.2.1 检测用户计划

1. 系统检测用户是否有现存的运动计划。
2. 如果用户没有现存计划，或计划已过期，或计划不符合期望，系统获取用户的健康档案。
3. 展示手动填写或自动生成选项。

##### 3.2.2.2 用户填写计划

1. 用户选择手动填写计划。
2. 用户完成填写后，系统检测计划的合理性。
3. 新计划添加到日程:

##### 3.2.2.3 自动生成计划

1. 用户选择自动生成计划。
2. 系统生成多个计划，用户选择其中一个。
3. 新计划添加到日程:

##### 3.2.2.4 对原有计划操作

1. 如果用户有有效计划且想手动调整，系统获取当前计划。
2. 系统给出保留计划、放弃计划、延长计划三个选项。
3. 用户选择其中保留、放弃、延长计划，计划就会被保留、放弃、延长1周。

#### 3.2.3  功能需求

**1.**   系统必须提供手动和自动计划创建的选项。

**2.**   在手动创建计划时，系统必须提示用户输入详细信息，如运动类型、持续时间和强度。

**3.**   在自动生成计划时，系统必须考虑用户的健康档案和偏好。

**4.**   系统必须验证手动输入计划的可行性和适当性。

**5.**   系统必须显示生成的计划供用户选择。

**6.**   用户必须能够将所选计划添加到其日程中。

##### 异常

1. 手动填写计划合理性检测异常。系统会提供清晰的错误信息，指导用户检查并修改不合理的计划。系统还可以提供一些建议来改进计划。
2. 自动生成计划不符合用户预期，提供用户评估生成的计划的选项，并允许用户选择或调整计划。系统可以收集反馈以改进自动生成计划的算法。（TBD）

### 3.3   运动记录

#### 3.3.1 描述

​    优先级：高

​    检测用户是否符合锻炼的条件，在记录锻炼数据的同时监测血糖。

#### 3.3.2 动机/生成顺序

1. 检测是否符合前提条件并且在饭后。

​    2. 系统进入运动模式，记录心跳与血糖。

​    3. 正常血糖时，周期性地（每3分钟）记录。

​    4. 生成运动报告，包括血糖、心率、速度、种类、异常情况、运动计划进度(如果有)等等。

#### 3.3.3 功能需求

1. 根据用户的健康档案和先前的运动计划，系统应检测用户是否符合进行饭后运动的前提条件。
2. 在正常血糖情况下，系统应每3分钟记录一次心跳率、血糖水平等数据。
3. 在运动结束后，系统应生成详细的运动报告，包括血糖水平、心跳率、运动速度、运动种类等信息。
4. 如果用户有运动计划，报告中应包含运动计划的进度。
5. 报告中应标识任何异常情况，如血糖异常或心跳异常。
6. 界面应清晰显示运动报告和运动计划。
7. 用户应能够手动触发运动模式或暂停运动记录。

##### 异常

1. 不符合运动的前提条件，展示前提条件并提示哪些条件不符，给出相应的建议。
2. 运动途中高血糖或低血糖，系统发出警报。
3. 运动途中高血糖，应该提醒立即停止运动并补水。
4. 运动途中低血糖，提醒补充葡萄糖，并提醒进行血糖与心率的自我监测。
5. 超出运动计划要求的频率、方式、强度等等，系统提醒用户合理计划。
6. 无法连接血糖仪，提醒用户多尝试连接几次血糖仪。

## 5. 外部接口需求
### 5.1 用户接口

#### 结构设计
##### 用户交互设计

 通过在首页点击血糖日历，就可以进入到血糖日历的首页，默认界面为显示实时血糖。
 ![image](https://github.com/SoftwareEngineeringMedical/.github/assets/103842499/700fe227-7fa5-4577-81c1-0927667ec7b5)

 实时血糖界面的主题是血糖在一天内的趋势图，图上用手指靠近任意一点，就可以显示该点血糖的详细信息，如下图。阴影部分表示运动，折线图下方是当前血糖值，通过红黄蓝来提醒用户是正常、低还是高血糖。血糖值下方是小贴士。
 ![image](https://github.com/SoftwareEngineeringMedical/.github/assets/103842499/c3c5d235-548b-4349-9ece-8739e2175571)

 界面布局紧凑，大小合理，例如血糖日历有两类界面，当选中一类时，其字体会加粗放大并跳转到相应界面。
 
 对于血糖记录，提供按日、周、月等跨度查看的选择。系统默认选项为日，用户也可以自己修改。参考Win10的日历设计，对日历选择进行了优化：先显示当前月的界面（选择日），点击当前月的文字就可以跳转到一个显示周的界面（选择周），标题仍然是月， 26~2日，3日到9日，10~16日....等等，再点击一下就能直接显示12个月（选择月）。不能选择的日期、月、周显示为灰色，防止用户做出错误的动作。
 
 对于运动方案，即使没有运动方案，用户也可以运动。运动方案的生成、运动过程中、检测是否符合运动前提条件等等界面均可以被打断，且均有相应警告。当用户不满意生成的运动方案时，可以选择再次生成。
 
 本系统的UI/UX设计遵循了“把控制权交给用户”与“减轻用户的记忆负担”等原则。
 
 当然，本系统的UI虽然由两个人设计，但风格是一致的。
 
##### 体系结构设计
### 5.2	软件接口

| 功能                           | Restful API              | Java参数(输入)                    | Java函数返回值             |
|-------------------------------|--------------------------|----------------------------------|---------------------------|
| 注册                          | POST /user               | 无                               | Integer(user_id)          |
| 注销                          | DELETE /user/{id}        | Integer(user_id)                 | void                      |
| 登录                          | PUT /user/{id}           | Integer(user_id), User           | Boolean                   |
| 查看用户个人信息               | GET /user/{id}           | Integer(user_id)                 | User                      |
| 获取血糖数据并记录              | POST /glycemia/{user_id} | Integer(user_id), Glycemia       | Boolean                   |
| 实时血糖数据的查询               | GET /glycemia/{user_id}  | Integer(user_id)                 | List<Glycemia>            |
| 查看运动计划                    | GET /scenario/{user_id}  | Integer(user_id)                 | Scenario                  |
| 创建/修改运动计划               | PUT /scenario/{user_id}  | Integer(user_id), Scenario       | Boolean                   |
| 删除当前运动计划                | DELETE /scenario/{user_id}| Integer(user_id)                 | Void                      |
| 查询是否符合运动的前提条件       | GET /profile/{user_id}   | Integer(user_id)                 | Boolean                   |
| 查询运动的复杂性条件             | GET /complication/{user_id}| Integer(user_id)                | Boolean                   |
| 记录运动                       | POST /exercise/{user_id}  | Integer(user_id), Exercise       | Boolean                   |
| 查看当日运动                    | GET /exercise/{user_id}?date={Date}| Integer(user_id), Date  | List<Exercise>            |
| 侦测实时心率                    | GET /heartrate/{user_id}  | Integer(user_id)                 | Heartrate                 |
| 查看当日血糖                    | GET /glycemia/{user_id}?Date={Date}| Integer(user_id), Date  | List<Glycemia>            |
| 检查身体                       | POST /examination/{user_id}| Integer(user_id), Examination   | Boolean                   |
| 查看体检结果                    | GET /examination/{user_id} | Integer(user_id)                 | Examination (Markdown)   |


### 5.3	硬件接口
用户通过组装传感器并将其贴敷到身上，打开本系统的APP，安卓手机需开启NFC功能。苹果手机用顶部贴近传感器激活，安卓手机用背部靠近传感器激活.

### 5.4	通信接口
#### 安卓APP与后端(Spring Boot)之间的通信:
1.	安卓APP与后端之间通常使用HTTP/HTTPS协议进行通信。
2.	安卓APP通过设备的网络连接（例如Wi-Fi、移动数据）建立与后端服务器的TCP连接。
3.	使用HTTP请求（GET、POST、PUT等）发送数据到后端，后端通过HTTP响应返回数据。
#### 后端(Spring Boot)与MySQL数据库之间的通信:
1.	后端通过JDBC（Java Database Connectivity）等数据库连接方式，建立与MySQL数据库的TCP连接。
2.	使用SQL协议执行数据库查询、更新等操作。
#### 后端(Spring Boot)与Nginx之间的通信:
1.	Nginx作为反向代理服务器，接收来自客户端（包括安卓APP）的HTTP请求。
2.	Nginx通过配置的代理规则将请求转发给后端的Spring Boot服务。
3.	Nginx和后端之间通过TCP连接进行通信，可以使用HTTP或FastCGI等协议。
#### Docker容器之间的通信:
1.	安卓APP与后端、后端与MySQL数据库之间的通信，都通过Docker网络进行。Docker容器可以通过在同一网络中来建立相互通信。
2.	使用Docker的网络命名空间，容器可以通过容器名称或IP地址相互访问。
3.	在Docker Compose或其他编排工具中定义容器间的网络关系。

